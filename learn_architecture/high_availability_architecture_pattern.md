
#### CAP定理
* 在一个分布式系统（指互相连接并共享数据的节点的集合）中，当涉及读写操作时，只能保证一致性、可用性、分区容错性三者中的两个
* 详细分析
  - 一致性：读操作能够返回最新的数据
  - 可用性：非故障节点在合理的时间内返回合理的响应（不是错误和超时响应）
  - 分区容错性：出现网络分区后，系统能够继续履行职责
* CAP应用
  - 必须选择分区容错要素，分布式理论上不能选择CA架构


#### CAP细节
* CAP关注的粒度是数据，而不是整个系统（同一系统中，有的数据需要满足CP，有的需要满足AP）
* CAP是忽略网络延迟的（C在实践中不能完美实现）
* 正常运行情况下，可以同时满足CA（节点网络连接一切正常）
* **ACID**：数据库系统为了保证事务正确性提出来的理论
  - 原子性；一致性；隔离性；持久性
* **BASE**: 基本可用、软状态、最终一致性，通过合适的方式达到最终一致性
  - 核心功能可用；允许系统存在中间状态，不影响整体可用性；数据最终一致
  
  
#### FMEA方法，排除架构可用性隐患的利器
* FMEA（Failure mode and effects anaysis）故障模式与影响分析，是一种可用性分析方法，通过对系统范围内潜在的故障模式加以分析，并按照严重程度进行分类，以确定失效对系统的最终影响
* 具体方法
  - 给出初始架构设计图
  - 假设架构中某个部件发生故障
  - 分析故障造成的影响
  - 判断是否需要优化
* 分析表格
  - 功能点：如注册、登录等
  - 故障模式：不需要原因，只需要故障现象
  - 故障影响：常见影响-功能点偶尔不可用、功能点完全不可用、部分用户功能点不可用、功能点响应缓慢、功能点出错等
  - 严重程序：致命/高/中/低/无
  - 故障原因：
  - 故障概率：高/中/低
    - 硬件；开源系统；自研系统
  - 风险程度：判断某个故障的最终等级
  - 已有措施：检测告警；容错；自恢复
  - 规避措施：可以是技术手段，也可以是管理手段
  - 解决措施：为了解决问题而做的一些事情，一般是技术手段
  - 后续规划：
  
  
#### 高可用存储架构：双机架构
* 存储高可用方案的本质是通过将数据复制到多个存储设备，通过数据冗余实现高可用。复杂性在于应对复制延迟和中断导致的数据不一致问题
  - 数据如何复制；如何应对复制延迟；如何应对复制中断
* 常见架构：主备、主从、主主、集群、分区
  - 主备复制：优点简单，只需复制数据，无须判断状态；缺点仅仅是备份，浪费硬件，故障无法自动恢复
  - 主从复制：
* 双机切换
  - 关键设计点：
    - 主备间状态判断（状态传递的渠道；状态检测的内容）
    - 切换决策（切换时机；切换策略；自动程度）
    - 自动程度
    - 数据冲突解决
  - 常见架构
    - 互连式：主备机直接建立状态传递的渠道
    - 中介式：主备之外通过第三方传递状态（连接管理更简单；状态决策更简单；单点）    
    - 模拟式：
* 主主复制：需要数据可以双向复制


#### 高可用存储架构：集群和分区
* 数据集群
  - 数据集中集群
    - 主机如何复制数据给备机：多条通道、数据不一致
    - 备机如何检测主机状态：
    - 主机故障后如何决定新的主机：
  - 数据分散集群
    - 数据均衡性
    - 容错性
    - 可伸缩性
* 数据分区：将数据按一定规则分区，不同分区分布在不同地理位置，规避地理级别的故障
  - 数据量：决定分区的规则复杂度
  - 分区规则：洲际分区、国家分区、城市分区
  - 复制规则：集中式、互备式、独立式
  
  
#### 如何设计计算高可用架构
* 设计思想：增加更多服务器
* 复杂度：任务管理，即任务执行失败后如何重新分配到新服务器
  - 哪些服务器可以执行任务：1，每个都可以；2，特定服务器执行
  - 任务如何重新执行：1，不做处理；2，任务管理器
* 常见架构
  - 主备：简单；切换慢；适用于低频任务
    - 冷备（业务未启动）；温备（业务启动，但不对外提供服务）
  - 主从：若主机不能恢复，则备升级为主，增加新机为从
  - 集群：
    - 对称集群：每个服务器角色一样。设计关键点：分配策略；检测服务器状态
    - 非对称集群：
      - 复杂度：分配策略更复杂；角色分配复杂
      

#### 业务高可用的保障：异地多活架构
* 应用场景：异地即地理位置不同；多活是多系统正常运行
  - 代价：复杂的架构；成本上升
* 架构模式
  - 同城异区：同一城市不同机房。应对机房级别故障
  - 跨城异地：距离要远，应对城市级故障。复杂度上升（网速降低、数据不一致）；强一致性要求的数据，无法做异地多活
  - 跨国异地：为不同地区提供服务；只读类业务多活
  

#### 异地多活4大技巧
* 保证核心业务的异地多活（保证登录，不考虑注册和修改信息）
* 保证核心数据一致性：保证最终一致性，不保证实时一致性
* 多种手段同步数据
  - 消息队列
  - 二次读取
  - 存储系统同步
  - 回源读取
  - 重新生成数据
* 只保证绝大多数用户的异地多活：异地多活也无法保证业务100%可用，这是物理规律决定的

#### 异地多活设计四步走
* 第一步：业务分级
  - 挑选出核心业务：访问量最大；产生收入的业务；
* 第二步：数据分类
  - 数据特征分析维度：数据量；唯一性；实时性；可丢失性；可恢复性
* 第三步：数据同步
  - 存储系统同步：简单但无法定制化
  - 消息队列同步：适合无事务性、无时序性数据
  - 重复生成：不同步再次生成即可
* 第四步：异常处理
  - 目的：问题发生时，避免少量数据异常导致系统不可用；修正异常数据；安抚用户弥补损失
  - 处理措施：
    - 多通道同步：两种即可；不使用相同的网络连接；数据可重复覆盖
    - 同步和访问结合：不使用相同的网络连接；数据有路由规则；优先读本地，无数据再访问其它机房
    - 日志记录：用于故障后对数据恢复
    - 用户补偿：


#### 如何应对接口级的故障
* 接口级故障一般原因：
  - 内因：程序BUG
  - 外因：攻击、促销导致大量请求
* 解决思路：保证核心业务及绝大部分用户
  - 降级：系统后门降级；独立降级系统
  - 熔断：应对依赖的外部系统的故障；实现关键在于统一的API调用层；另一关键是阀值
  - 限流：从用户访问压力角度考虑
    - 基于请求限流：限制总量、限制时间量 
    - 其于资源限流：连接数、线程数、请求队列等
  - 排队：让用户等一段时间