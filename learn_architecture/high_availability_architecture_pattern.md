
#### CAP定理
* 在一个分布式系统（指互相连接并共享数据的节点的集合）中，当涉及读写操作时，只能保证一致性、可用性、分区容错性三者中的两个
* 详细分析
  - 一致性：读操作能够返回最新的数据
  - 可用性：非故障节点在合理的时间内返回合理的响应（不是错误和超时响应）
  - 分区容错性：出现网络分区后，系统能够继续履行职责
* CAP应用
  - 必须选择分区容错要素，分布式理论上不能选择CA架构


#### CAP细节
* CAP关注的粒度是数据，而不是整个系统（同一系统中，有的数据需要满足CP，有的需要满足AP）
* CAP是忽略网络延迟的（C在实践中不能完美实现）
* 正常运行情况下，可以同时满足CA（节点网络连接一切正常）
* **ACID**：数据库系统为了保证事务正确性提出来的理论
  - 原子性；一致性；隔离性；持久性
* **BASE**: 基本可用、软状态、最终一致性，通过合适的方式达到最终一致性
  - 核心功能可用；允许系统存在中间状态，不影响整体可用性；数据最终一致
  
  
#### FMEA方法，排除架构可用性隐患的利器
* FMEA（Failure mode and effects anaysis）故障模式与影响分析，是一种可用性分析方法，通过对系统范围内潜在的故障模式加以分析，并按照严重程度进行分类，以确定失效对系统的最终影响
* 具体方法
  - 给出初始架构设计图
  - 假设架构中某个部件发生故障
  - 分析故障造成的影响
  - 判断是否需要优化
* 分析表格
  - 功能点：如注册、登录等
  - 故障模式：不需要原因，只需要故障现象
  - 故障影响：常见影响-功能点偶尔不可用、功能点完全不可用、部分用户功能点不可用、功能点响应缓慢、功能点出错等
  - 严重程序：致命/高/中/低/无
  - 故障原因：
  - 故障概率：高/中/低
    - 硬件；开源系统；自研系统
  - 风险程度：判断某个故障的最终等级
  - 已有措施：检测告警；容错；自恢复
  - 规避措施：可以是技术手段，也可以是管理手段
  - 解决措施：为了解决问题而做的一些事情，一般是技术手段
  - 后续规划：
  
  
#### 高可用存储架构：双机架构
* 存储高可用方案的本质是通过将数据复制到多个存储设备，通过数据冗余实现高可用。复杂性在于应对复制延迟和中断导致的数据不一致问题
  - 数据如何复制；如何应对复制延迟；如何应对复制中断
* 常见架构：主备、主从、主主、集群、分区
  - 主备复制：优点简单，只需复制数据，无须判断状态；缺点仅仅是备份，浪费硬件，故障无法自动恢复
  - 主从复制：
* 双机切换
  - 关键设计点：
    - 主备间状态判断（状态传递的渠道；状态检测的内容）
    - 切换决策（切换时机；切换策略；自动程度）
    - 自动程度
    - 数据冲突解决
  - 常见架构
    - 互连式：主备机直接建立状态传递的渠道
    - 中介式：主备之外通过第三方传递状态（连接管理更简单；状态决策更简单；单点）    
    - 模拟式：
* 主主复制：需要数据可以双向复制


#### 高可用存储架构：集群和分区
* 数据集群
  - 数据集中集群
    - 主机如何复制数据给备机：多条通道、数据不一致
    - 备机如何检测主机状态：
    - 主机故障后如何决定新的主机：
  - 数据分散集群
    - 数据均衡性
    - 容错性
    - 可伸缩性
* 数据分区：将数据按一定规则分区，不同分区分布在不同地理位置，规避地理级别的故障
  - 数据量：决定分区的规则复杂度
  - 分区规则：洲际分区、国家分区、城市分区
  - 复制规则：集中式、互备式、独立式
  
  
#### 如何设计计算高可用架构
* 设计思想：增加更多服务器
* 复杂度：任务管理，即任务执行失败后如何重新分配到新服务器
  - 哪些服务器可以执行任务：1，每个都可以；2，特定服务器执行
  - 任务如何重新执行：1，不做处理；2，任务管理器
* 常见架构
  - 主备：简单；切换慢；适用于低频任务
    - 冷备（业务未启动）；温备（业务启动，但不对外提供服务）
  - 主从：若主机不能恢复，则备升级为主，增加新机为从
  - 集群：
    - 对称集群：每个服务器角色一样。设计关键点：分配策略；检测服务器状态
    - 非对称集群：
      - 复杂度：分配策略更复杂；角色分配复杂